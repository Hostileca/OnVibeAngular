<div
  class="d-flex"
  [ngClass]="{
    'justify-content-end': isOutgoing,
    'justify-content-start': !isOutgoing && !isSystem,
    'justify-content-center': isSystem
  }"
>
  <div
    class="message d-inline-block mb-2 px-3 py-2 rounded shadow-sm"
    (contextmenu)="onRightClick($event)"
    [class.bg-primary-subtle]="isOutgoing"
    [class.bg-light]="!isOutgoing && !isSystem"
    [class.bg-secondary-subtle]="isSystem"
    [class.text-muted]="isSystem"
    style="max-width: 75%; word-break: break-word;"
  >
    <div class="message-sender d-flex align-items-center mb-1" *ngIf="!isOutgoing && !isSystem">
      <img
        [src]="senderAvatarUrl || Assets.userDefaultAvatar"
        [alt]="item.sender.username + ' avatar'"
        class="sender-avatar rounded-circle me-2"
        width="32"
        height="32"
      >
      <span class="sender-name fw-semibold">{{ item.sender.username }}</span>
    </div>

    <div class="message-content">
      <p class="mb-1 m-0">{{ item.text }}</p>
      <span class="message-time small text-body-secondary">
        {{ item.date | date: 'HH:mm' }}
        <i *ngIf="!isOutgoing || (isOutgoing && isReadByAnyUser)" class="bi bi-check2-all ms-1 text-primary read-receipt"></i>
        <i *ngIf="isOutgoing && !isReadByAnyUser" class="bi bi-check2 ms-1 text-primary read-receipt"></i>
      </span>
    </div>

    <div *ngIf="mediaAttachments.length > 0" class="mb-3">
      <div class="position-relative">
        <div class="position-relative carousel-wrapper">
          <ngb-carousel
            *ngIf="mediaAttachments.length > 1"
            [interval]="0"
            [showNavigationArrows]="true"
            [showNavigationIndicators]="true">
            <ng-template ngbSlide *ngFor="let media of mediaAttachments">
              <div class="carousel-image-container">
                <img
                  *ngIf="FileHelper.isImage(media)"
                  [src]="media.blob | blobUrl"
                  class="d-block mx-auto carousel-image"
                  [alt]="media.fileName">

                <video
                  *ngIf="FileHelper.isVideo(media)"
                  controls
                  class="d-block mx-auto carousel-video">
                  <source [src]="media.blob | blobUrl" [type]="getVideoType(media)">
                </video>
              </div>
            </ng-template>
          </ngb-carousel>
        </div>

        <div *ngIf="mediaAttachments.length === 1" class="text-center">
          <img *ngIf="FileHelper.isImage(mediaAttachments[0])"
               [src]="mediaAttachments[0].blob | blobUrl"
               [alt]="mediaAttachments[0].fileName"
               class="img-fluid rounded"
               style="max-height: 500px; max-width: 100%; object-fit: contain;">

          <video *ngIf="FileHelper.isVideo(mediaAttachments[0])"
                 controls
                 class="img-fluid rounded"
                 style="max-height: 500px; max-width: 100%; object-fit: contain;">
            <source [src]="mediaAttachments[0].blob | blobUrl" [type]="getVideoType(mediaAttachments[0])">
          </video>
        </div>
      </div>
    </div>

    <div *ngIf="otherAttachments.length > 0" class="mb-3">
      <div class="list-group">
        <div *ngFor="let file of otherAttachments" class="list-group-item list-group-item-action d-flex flex-column align-items-start">
          <div class="d-flex w-100 align-items-center">
            <i class="bi me-2" [ngClass]="FileHelper.getFileIcon(file)"></i>
            <span class="flex-grow-1">{{ file.fileName }}</span>
            <small class="text-muted">{{ file.blob.size | fileSize }}</small>
          </div>

          <audio *ngIf="FileHelper.isAudio(file)"
                 controls
                 class="audio-mini mt-2 w-100">
            <source [src]="file.blob | blobUrl" [type]="getAudioType(file)">
            Your browser does not support the audio element.
          </audio>
        </div>
      </div>
    </div>

    <div class="message-reactions d-flex mt-1">
      <span
        *ngFor="let emoji of Object.keys(groupedReactions)"
        class="reaction-icon me-1 pointer-event"
        (click)="react(emoji)"
        [ngClass]="{
          'border border-primary rounded-circle': isMyReaction(emoji), 'p-1': isMyReaction(emoji)
        }"
      >
        {{ emoji }} <span *ngIf="groupedReactions[emoji] > 1">({{ groupedReactions[emoji] }})</span>
      </span>
    </div>

  </div>
</div>

<app-message-context-menu [message]="item"></app-message-context-menu>
